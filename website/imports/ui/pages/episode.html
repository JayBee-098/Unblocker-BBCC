<template name="pages_episode">
  <div class="container">

    <div class="card-panel">
      {{#autoForm schema='Schemas.episodeSelection' id='episodeSelectionForm' autosave=true}}
        <div class="row">
          <div class="col s2">
            <button class="waves-effect waves-teal btn btn-select-prev">{{>tooltippedIcon icon='chevron_left' iconClass='left' text='Previous Episode' position='right'}}</button>
          </div>
          <div class="col s8">
            {{> afQuickField name='episodeNumber' options=episodeSelectionOptions defaultValue=episodeSelectionDefaultValue id='episodeNumberSelection'}}
          </div>
          <div class="col s2">
            <button class="waves-effect waves-teal btn btn-select-next">{{>tooltippedIcon icon='chevron_right' iconClass='right' text='Next Episode' position='right'}}</button>
          </div>
        </div>
      {{/autoForm}}
    </div>

    {{#each iframeError in iframeErrors}}
      {{#if $eq iframeError 'unknown'}}
        <div class="card-panel">
          <h4 class="card-title">This video is not working for an unknown reason.</h4>
          <p class="flow-text">
            This is most likely because the video is no longer available. Please try another video.
          </p>
        </div>
      {{/if}}

      {{#if $eq iframeError 'cloudflare'}}
        <div class="card-panel">
          <h4 class="card-title">Disable the Cloudflare filter once to watch this video.</h4>
          <p class="flow-text">
            <a href="{{selectedEpisode.streamer.homepage}}" target="_blank" rel="noopener">Click here to disable the filter.</a>
            This will open a new tab.
            There, you will have to wait for this to complete:<br>
            <img class="disable-cloudflare-filter-image" src="/media/images/cloudflare-challenge-simple.png">
            <strong>Return here</strong> once the loading is done and reload this page.
            You can close the new tab once you are done.
          </p>
        </div>
      {{/if}}

      {{#if $eq iframeError 'mixed-content'}}
        <div class="card-panel">
          <h4 class="card-title">Disable mixed content protection to watch this video.</h4>
          <p class="flow-text">
            {{#if $eq $.BrowserDetect.browser 'Firefox'}}
              <img class="disable-mixed-protection-image" src="/media/images/firefox-unsafe-1.png">
              <img class="disable-mixed-protection-image" src="/media/images/firefox-unsafe-2.png">
            {{/if}}
            {{#if $eq $.BrowserDetect.browser 'Chrome'}}
              <img class="disable-mixed-protection-image" src="/media/images/chrome-unsafe-1.png">
              <img class="disable-mixed-protection-image" src="/media/images/chrome-unsafe-2.png">
            {{/if}}
          </p>
        </div>
      {{/if}}

      {{#if $eq iframeError 'flash'}}
        <div class="card-panel">
          <h4 class="card-title">This video requires Adobe Flash Player to be played.</h4>
          <p class="flow-text">
            <a href="https://get.adobe.com/flashplayer/" target="_blank" rel="noopener">You can get it here.</a>
            Make sure to uncheck the optional offers.
          </p>
        </div>
      {{/if}}

      {{#if $eq iframeError 'x-frame-options'}}
        <div class="card-panel">
          <h4 class="card-title">This video cannot be watched without the companion browser add-on.</h4>
          <p class="flow-text">
            {{>pages_episode_get_addon}}
          </p>
        </div>
      {{/if}}

      {{#if $eq iframeError 'add-on'}}
        <div class="card-panel">
          <h4 class="card-title">Most issues related to videos not working will be solved by installing the companion browser add-on.</h4>
          <p class="flow-text">
            {{>pages_episode_get_addon}}
          </p>
        </div>
      {{/if}}
    {{/each}}

    <div class="card-panel {{#if iframeErrors}}removed{{/if}}" id="player-container-panel">
      <div id="player-container-outer">
        <div id="player-container-inner">
          <iframe id="episode-frame" src="{{selectedSource.url}}" allowfullscreen></iframe>
        </div>
      </div>
      <div class="under-player-container">
        <a class="waves-effect waves-light btn btn-not-working">Video not working?</a>
        Try another video first.
      </div>
    </div>

    <div class="card-panel">
      {{#each episode in episodes}}
        <ul class="collection with-header">
          <li class="collection-header">
            <h5>{{episode.streamer.name}}</h5>
          </li>
          <li class="collection-item source-button-container">
            {{#each source in episode.sources}}
              <a class="waves-effect waves-light btn btn-source {{#if flagsDisabled source.flags}}disabled{{/if}} {{#if $eq selectedSource.name source.name}}{{#if $eq selectedEpisode._id episode._id}}primary-color{{/if}}{{/if}}" data-episode="{{episode._id}}" data-source="{{source.name}}">
                {{source.name}}
                {{#each flag in source.flags}}
                  {{#if showIcon flag}}
                    {{#if $eq flag 'x-frame-options'}}
                      {{>tooltippedIcon icon='block' iconClass='right' text='Abuses X-Frame-Options' position='right'}}
                    {{/if}}
                    {{#if $eq flag 'cloudflare'}}
                      {{>tooltippedIcon icon='cloud_off' iconClass='right' text='Uses Cloudflare Filtering' position='right'}}
                    {{/if}}
                    {{#if $eq flag 'mixed-content'}}
                      {{>tooltippedIcon icon='lock_open' iconClass='right' text='Has Mixed Content' position='right'}}
                    {{/if}}
                    {{#if $eq flag 'flash'}}
                      {{>tooltippedIcon icon='flash_off' iconClass='right' text='Uses Flash Player' position='right'}}
                    {{/if}}
                  {{/if}}
                {{/each}}
              </a>
            {{/each}}
          </li>
        </ul>
      {{/each}}
    </div>

  </div>
  {{> components_loading_indicator_background state=updating}}
</template>

<template name="pages_episode_get_addon">
  {{#if $eq $.BrowserDetect.browser 'Firefox'}}
    <a class="waves-effect waves-light btn" href="https://addons.mozilla.org/en-US/firefox/addon/animesentinel-companion-addon/" target="_blank" rel="noopener">Get it here!</a>
  {{else}}
    Unfortunately your browser is not supported yet.
  {{/if}}
</template>
