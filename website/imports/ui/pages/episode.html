<template name="pages_episode">
  <div class="container">

    <div class="card-panel">
      {{#autoForm schema='Schemas.episodeSelection' id='episodeSelectionForm' autosave=true}}
        <div class="row">
          <div class="col s2">
            <button class="waves-effect waves-teal btn btn-select-prev">{{>tooltippedIcon icon='chevron_left' text='Previous Episode' position='right'}}</button>
          </div>
          <div class="col s8">
            {{> afQuickField name='episodeNumber' options=episodeSelectionOptions defaultValue=episodeSelectionDefaultValue id='episodeNumberSelection'}}
          </div>
          <div class="col s2">
            <button class="waves-effect waves-teal btn btn-select-next">{{>tooltippedIcon icon='chevron_right' text='Next Episode' position='right'}}</button>
          </div>
        </div>
      {{/autoForm}}
    </div>

    {{#if $in 'unknown' iframeErrors}}
      <div class="card-panel">
        <h4 class="card-title">
          <i class="material-icons">priority_high</i>
          This video is not working for an unknown reason.
        </h4>
        <p class="flow-text">
          This is most likely because the video is no longer available. Please try another video.
        </p>
      </div>
    {{/if}}

    {{#if $in 'cloudflare' iframeErrors}}
      <div class="card-panel">
        <h4 class="card-title">
          <i class="material-icons">cloud_off</i>
          Disable the Cloudflare filter once to watch this video.
        </h4>
        <p class="flow-text">
          <a href="{{selectedStreamerHomepage}}" target="_blank" rel="noopener">Click here to disable the filter.</a>
          This will open a new tab.
          There, you will have to wait for this to complete:<br>
          {{>components_image src="/media/cloudflare-challenge-simple.png" caption="Cloudflare's Loading Indicator" class="disable-cloudflare-filter-image"}}
          <strong>Return here</strong> once the loading is done and reload this page.
          You can close the new tab once you are done.
        </p>
      </div>
    {{/if}}

    {{#if $in 'mixed-content' iframeErrors}}
      <div class="card-panel">
        <h4 class="card-title">
          <i class="material-icons">lock_open</i>
          Disable mixed content protection to watch this video.
        </h4>
        <p class="flow-text">
          {{#if $eq $.BrowserDetect.browser 'Firefox'}}
            {{>components_image src="/media/firefox-unsafe-1.png" caption="Firefox - Step 1" class="disable-mixed-protection-image"}}
            {{>components_image src="/media/firefox-unsafe-2.png" caption="Firefox - Step 2" class="disable-mixed-protection-image"}}
          {{/if}}
          {{#if $eq $.BrowserDetect.browser 'Chrome'}}
            {{>components_image src="/media/chrome-unsafe-1.png" caption="Chrome - Step 1" class="disable-mixed-protection-image"}}
            {{>components_image src="/media/chrome-unsafe-2.png" caption="Chrome - Step 2" class="disable-mixed-protection-image"}}
          {{/if}}
        </p>
      </div>
    {{/if}}

    {{#if $in 'flash' iframeErrors}}
      <div class="card-panel">
        <h4 class="card-title">
          <i class="material-icons">flash_off</i>
          This video requires Adobe Flash Player to be played.
        </h4>
        <p class="flow-text">
          <a href="https://get.adobe.com/flashplayer/" target="_blank" rel="noopener">You can get it here.</a>
          Make sure to uncheck the optional offers.
        </p>
      </div>
    {{/if}}

    {{#if $in 'requires-plugins' iframeErrors}}
      <div class="card-panel">
        <h4 class="card-title">
          <i class="material-icons">layers_clear</i>
          This video does not work with Iframe Sandboxing.
        </h4>
        <p class="flow-text">
          Reload the page and uncheck 'Enable Iframe Sandboxing' below the video.
          Alternatively, use a different browser.
          Note that Iframe Sandboxing blocks popups even when not using an adblocker.
        </p>
      </div>
    {{/if}}

    {{#if $in 'x-frame-options' iframeErrors}}
      <div class="card-panel">
        <h4 class="card-title">
          <i class="material-icons">block</i>
          This video cannot be watched without the companion browser add-on.
        </h4>
        <p class="flow-text">
          {{>pages_episode_get_addon}}
        </p>
      </div>
    {{/if}}

    {{#if $in 'add-on' iframeErrors}}
      <div class="card-panel">
        <h4 class="card-title">
          <i class="material-icons">extension</i>
          Most issues related to videos not working will be solved by installing the companion browser add-on.
        </h4>
        <p class="flow-text">
          {{>pages_episode_get_addon}}
        </p>
      </div>
    {{/if}}

    <div class="card-panel {{#if iframeErrors}}removed{{/if}}" id="player-container-panel">
      <div id="player-container-outer">
        <div id="player-container-inner">
          {{#if frameSandboxingEnabled}}
            <iframe id="episode-frame" src="{{selectedSourceUrl}}" allowfullscreen referrerpolicy="no-referrer" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
          {{else}}
            <iframe id="episode-frame" src="{{selectedSourceUrl}}" allowfullscreen referrerpolicy="no-referrer"></iframe>
          {{/if}}
        </div>
      </div>
      <div class="under-player-container">
        <a class="waves-effect waves-light btn btn-not-working">Video not working?</a>
        Try another video first.
        <div class="input-field right">
          <input type="checkbox" id="sandboxing-checkbox" checked="{{#if frameSandboxingEnabled}}checked{{/if}}">
          <label for="sandboxing-checkbox">Enable Iframe Sandboxing</label>
        </div>
      </div>
    </div>

    <div class="card-panel">
      {{#each result in episodesByStreamer}}
        <ul class="collection with-header">
          <li class="collection-header">
            <h5>{{result.streamer.name}}</h5>
          </li>
          <li class="collection-item source-button-container">
            {{#each episode in result.episodes}}
              <a class="
                waves-effect waves-light btn btn-source
                {{#if flagsDisabled episode.flags}}disabled{{/if}}
                {{#if $eq selectedSourceName episode.sourceName}}{{#if $eq selectedStreamerId result.streamer.id}}primary-color{{/if}}{{/if}}
              " data-sourcename="{{episode.sourceName}}" data-streamerid="{{result.streamer.id}}">
                {{#each flag in episode.flags}}
                  {{#if showIcon flag}}
                    {{#if $eq flag 'x-frame-options'}}
                      {{>tooltippedIcon icon='block' iconClass='right' text='Abuses X-Frame-Options' position='right'}}
                    {{/if}}
                    {{#if $eq flag 'cloudflare'}}
                      {{>tooltippedIcon icon='cloud_off' iconClass='right' text='Uses Cloudflare Filtering' position='right'}}
                    {{/if}}
                    {{#if $eq flag 'mixed-content'}}
                      {{>tooltippedIcon icon='lock_open' iconClass='right' text='Has Mixed Content' position='right'}}
                    {{/if}}
                    {{#if $eq flag 'flash'}}
                      {{>tooltippedIcon icon='flash_off' iconClass='right' text='Uses Flash Player' position='right'}}
                    {{/if}}
                    {{#if $eq flag 'requires-plugins'}}
                      {{>tooltippedIcon icon='layers_clear' iconClass='right' text='Requires Plugin Access' position='right'}}
                    {{/if}}
                  {{/if}}
                {{/each}}
                {{episode.sourceName}}
                <!--({{displayUploadDate episode.uploadDate}})-->
              </a>
            {{/each}}
          </li>
        </ul>
      {{/each}}
    </div>

  </div>
</template>

<template name="pages_episode_get_addon">
  {{#if $eq $.BrowserDetect.browser 'Firefox'}}
    <a class="waves-effect waves-light btn" href="https://addons.mozilla.org/en-US/firefox/addon/animesentinel-companion-addon/" target="_blank" rel="noopener">Get it here!</a>
  {{else}}
    Unfortunately your browser is not supported yet.
  {{/if}}
</template>
